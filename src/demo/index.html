<!DOCTYPE html>
<html>

<head>
    <title>MOSES Demo Application</title>
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/leaflet.css" />
    <link rel="stylesheet" href="css/leaflet.draw.css" />
    <link rel="stylesheet" href="css/leaflet.awesome-markers.css">
    <link rel="stylesheet" href="css/demo.css" />
</head>

<body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">MOSES</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="#">Home</a></li>
                    <li><a href="#about">About</a></li>
                    <li><a href="#contact">Docs</a></li>
                </ul>
            </div>
            <!--/.nav-collapse -->
        </div>
    </nav>
    <div class="container">
        <div class="starter-template">
            <h1>MOSES Demo</h1>
            <h3 style="margin: 0px;">(Marklogic Originating Spatial Evaluation Service)</h3>
            <div>
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active" id="searchTab"><a href="#search" aria-controls="search" role="tab" data-toggle="tab">Search Manually</a></li>
                    <li role="presentation" id="extractTab"><a href="#extract" aria-controls="extract" role="tab" data-toggle="tab">Automatic Entity Extraction</a></li>
                </ul>
            </div>
            <div class="tab-content">
                <div id="search" class="tab-pane active">
                    <form id="search-form">
                        <div class="search-row">
                            <div class="input-group">
                                <span class="input-group-addon" id="basic-addon3">Name</span>
                                <input type="text" class="form-control" id="name" placeholder="Name of the place, ex: Empire State Building" aria-describedby="basic-addon3">
                            </div>
                            <div class="input-group">
                                <select id='fuzzy' class="selectpicker">
                                    <option value="" selected>Fuzzy Name Search Off</option>
                                    <option value="true">Fuzzy Name Search On</option>
                                </select>
                            </div>
                        </div>
                        <div class="search-row">
                            <label>Population</label>
                            <div class="input-group">
                                <select id='population-inequality' class="selectpicker" style="float: left;">
                                    <option value=">" selected>More Than</option>
                                    <option value="<">Less Than</option>
                                </select>
                                <input type="text" class="form-control" id="population-amount" pattern="[0-9]" placeholder="Example 0 or 50000">
                            </div>
                        </div>
                        <div class="search-row">
                            <label>Feature Class</label>
                            <div class="input-group">
                                <select id='featureClass' class="selectpicker">
                                    <option value="" selected>All</option>
                                </select>
                            </div>
                        </div>
                        <div class="search-row" id="featureCode-div">
                            <label>Sub Class</label>
                            <div class="input-group">
                                <select id='featureCode' class="selectpicker">
                                    <option value="" selected>Select a class first</option>
                                </select>
                            </div>
                        </div>
                        <div class="search-row">
                            <label>Country</label>
                            <div class="input-group">
                                <select id='countryCode' class="selectpicker">
                                    <option value="" selected>All</option>
                                </select>
                            </div>
                        </div>
                        <div class="search-row" id="admin1Code-div">
                            <label>Province</label>
                            <div class="input-group">
                                <select id='admin1Code' class="selectpicker">
                                    <option value="" selected>Select a country first</option>
                                </select>
                            </div>
                        </div>
                        <div class="search-row" id="admin2Code-div">
                            <label>District</label>
                            <div class="input-group">
                                <select id='admin2Code' class="selectpicker">
                                    <option value="" selected>Select a province first</option>
                                </select>
                            </div>
                        </div>
                        <div class="search-row">
                            <label>Max Results</label>
                            <div class="input-group">
                                <select id='limit' class="selectpicker">
                                    <option value="1">1</option>
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="25" selected>25</option>
                                    <option value="100">100</option>
                                    <option value="500">500</option>
                                </select>
                            </div>
                        </div>
                        <div class="search-row">
                            <label>Sort By</label>
                            <div class="input-group">
                                <select id='sortType' class="selectpicker">
                                    <option value="asciiname">Name</option>
                                    <option value="population" selected>Population</option>
                                    <option value="featureClass">Feature Class</option>
                                    <option value="countryCode">Country</option>
                                </select>
                            </div>
                        </div>
                        <div class="search-row">
                            <label>Sort Order</label>
                            <div class="input-group">
                                <select id='sortOrder' class="selectpicker">
                                    <option value="ascending">Ascending</option>
                                    <option value="descending" selected>Descending</option>
                                </select>
                            </div>
                        </div>
                        <div class="search-row submit-row">
                            <button type="button" class="btn btn-primary btn-lg" aria-label="Search!" id="submitButton">
                                <span class="glyphicon glyphicon-search"></span> Find Locations
                            </button>
                        </div>
                    </form>
                </div>
                <div id="extract" class="tab-pane">
                    <div id="extracted">
                        <div class="search-row">
                            <label>Raw text:</label>
                            <div class="input-group">
                                <select id='engine' class="selectpicker">
                                    <option value="" selected>Built-in Tagger</option>
                                    <option value="nlp">Stanford NLP</option>
                                </select>
                            </div>
                            <textarea class="form-control" rows="14" id="extract-text">China has denied a U.S. aircraft carrier entry into a Hong Kong port, according to Pentagon spokesman Cmdr. Bill Urban. Meanwhile, the New York Yankees have won their sixth game of the series, heading to Boston next week to play the final game of the world series. In other news, Russia issued a statement by President Vladimir Putin that they will not cease operations in Syria. Additionally, the U.S. Navy has formally begun construction on its newest Virginia-class submarine, as Jill Biden, wife of Vice President Joe Biden and the sub's sponsor, hosted the keel laying ceremony for the USS Delaware in Virginia.
                            </textarea>
                        </div>
                        <div class="search-row submit-row">
                            <button type="button" class="btn btn-primary btn-lg" aria-label="Search!" id="extractButton">
                                <span class="glyphicon glyphicon-search"></span> Extract Locations
                            </button>
                        </div>
                    </div>
                </div>
                <div id="processed">
                    <div class="search-row">
                        <p>
                            <label>Enriched Text</label>
                        </p>
                        <p>
                            <div id="enrich-text" class="well">
                            </div>
                        </p>
                    </div>
                    <div class="search-row submit-row">
                        <button type="button" class="btn" aria-label="Search!" id="processedButton">
                            Go back </button>
                    </div>
                </div>
            </div>
            <div id="mapid"></div>
        </div>
        <div id="results">
            <table class="table table-hover">
                <thead id="results-header">
                    <tr>
                        <th>id</th>
                        <th>Name</th>
                        <th>Country</th>
                        <th>Province</th>
                        <th>District</th>
                        <th>Feature</th>
                        <th>Population</th>
                        <th>Lat</th>
                        <th>Lon</th>
                    </tr>
                </thead>
                <tbody id="results-table"></tbody>
            </table>
        </div>
    </div>
    <!-- /.container -->
    <script src="js/leaflet.js"></script>
    <script src="js/leaflet.draw.js"></script>
    <script src="js/jquery-2.2.3.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/leaflet.awesome-markers.js"></script>
    <script src="js/main.js"></script>
    <!--- this is where the initial map creation is going to keep it out -->
    <script>
    //setup stuff - map, leaflet
    var map = L.map('mapid').setView([0, 0], 2);
    //let's use some sweet ESRI maps to do this width
    var streetMapUrl = 'http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}';
    var streetMapLayer = new L.TileLayer(streetMapUrl, {
        maxZoom: 19,
        attribution: 'Tiles: &copy; Esri'
    });

    var orangeIcon = L.AwesomeMarkers.icon({
        icon: 'star',
        markerColor: 'orange'
    });

    var searchIcon = L.AwesomeMarkers.icon({
        icon: 'search',
        markerColor: 'green'
    });

    var redIcon = L.AwesomeMarkers.icon({
        icon: 'star',
        markerColor: 'red'
    });

    var defaultIcon = new L.Icon.Default();

    //add layer to map
    map.addLayer(streetMapLayer);

    //drawing tools to do our neat geospatial querys
    // Initialise the FeatureGroup to store editable layers

    var editableLayers = new L.FeatureGroup();
    map.addLayer(editableLayers);

    var markers = new L.FeatureGroup();

    // Initialise the draw control and pass it the FeatureGroup of editable layers
    var options = {
        position: 'topright',
        draw: {
            polyline: false,
            polygon: {
                allowIntersection: false, // Restricts shapes to simple polygons
                drawError: {
                    color: '#e1e100', // Color the shape will turn when intersects
                    message: '<strong>Oh snap!<strong> you can\'t draw that!' // Message that will show when intersect
                },
                shapeOptions: {
                    color: '#bada55'
                }
            },
            circle: {
                shapeOptions: {
                    clickable: true
                },
                showRadius: true,
                metric: false
            }, // Turns off this drawing tool
            rectangle: false,
            marker: {
                icon: searchIcon
            }
        },
        edit: {
            featureGroup: editableLayers //REQUIRED!!

        }
    };

    var drawControl = new L.Control.Draw(options);
    map.addControl(drawControl);

    //now enable an event so we can draw something
    map.on('draw:created', function(e) {
        var type = e.layerType,
            layer = e.layer;
        if (editableLayers && editableLayers.getLayers().length !== 0) {
            editableLayers.clearLayers();
        }
        if (type === 'marker') {
            window.geo = {
                type: 'point',
                points: layer.getLatLng()
            };
            window.geo.points.lat = window.geo.points.lat.toFixed(5);
            window.geo.points.lng = window.geo.points.lng.toFixed(5);
            layer.bindPopup('<p><strong>Lat:</strong> ' + window.geo.points.lat + '<br /> <strong>Lon:</strong> ' + window.geo.points.lng + '</p>');
        }
        if (type === 'circle') {
            window.geo = {
                type: 'circle',
                radius: ((layer.getRadius()) * (0.000621371)).toFixed(5),
                points: layer.getLatLng()
            };
            window.geo.points.lat = window.geo.points.lat.toFixed(5);
            window.geo.points.lng = window.geo.points.lng.toFixed(5);
        }

        if (type === 'polygon') {
            coordinates = [];
            latlngs = layer.getLatLngs();
            for (var i = 0; i < latlngs.length; i++) {
                coordinates.push([latlngs[i].lng.toFixed(5), latlngs[i].lat.toFixed(5)]);
            }

            window.geo = {
                type: 'polygon',
                points: coordinates
            };
        }

        editableLayers.addLayer(layer);
    });

    //could probably combine this with the on observer above, but this is a demo, this is for editing the shapes:
    map.on('draw:edited', function(e) {
        var layers = e.layers;
        layers.eachLayer(function(layer) {
            if (layer instanceof L.Marker) {
                window.geo = {
                    type: 'point',
                    points: layer.getLatLng()
                };
                window.geo.points.lat = window.geo.points.lat.toFixed(5);
                window.geo.points.lng = window.geo.points.lng.toFixed(5);
                layer.bindPopup('<p><strong>Lat:</strong> ' + window.geo.points.lat + '<br /> <strong>Lon:</strong> ' + window.geo.points.lng + '</p>');
            }
            if (layer instanceof L.Circle) {
                window.geo = {
                    type: 'circle',
                    radius: ((layer.getRadius()) * (0.000621371)).toFixed(5),
                    points: layer.getLatLng()
                };
                window.geo.points.lat = window.geo.points.lat.toFixed(5);
                window.geo.points.lng = window.geo.points.lng.toFixed(5);
            }
            if (layer instanceof L.Polygon) {
                coordinates = [];
                latlngs = layer.getLatLngs();
                for (var i = 0; i < latlngs.length; i++) {
                    coordinates.push([latlngs[i].lng.toFixed(5), latlngs[i].lat.toFixed(5)]);
                }
                window.geo = {
                    type: 'polygon',
                    points: coordinates
                };
            }
        });
    });

    map.on('draw:deleted', function(e) {
        var type = e.layerType,
            layer = e.layer;
        editableLayers.clearLayers();
        window.geo = null;
    });

    $(document).ready(function() {
        $("#population-amount").keypress(function(e) {
            if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)) {
                return false;
            }
        });

        //load up our list of countries
        getCountries();
        getFeatureClass();

        //monitor our initial select boxes for change
        $('#countryCode').change(function(e) {
            if (e.target.value !== '' && e.target.value !== null) {
                getProvince(e.target.value);
                $('#admin1Code').parent().parent().slideDown();
            } else {
                $('#admin1Code').html('<option value="">Select a country first</option>').parent().parent().slideUp();
                $('#admin2Code').html('<option value="">Select a province first</option>').parent().parent().slideUp();
            }
        });

        //monitor our initial select boxes for change
        $('#admin1Code').change(function(e) {
            if (e.target.value !== '' && e.target.value !== null) {
                getDistrict($('#countryCode').val(), e.target.value.split('.')[1]);
                $('#admin2Code').parent().parent().slideDown();
            } else {
                $('#admin2Code').html('<option value="">Select a province first</option>').parent().parent().slideUp();
            }
        });

        //monitor our initial select boxes for change
        $('#featureClass').change(function(e) {
            if (e.target.value !== '' && e.target.value !== null) {
                getFeatureCode(e.target.value);
                $('#featureCode').parent().parent().slideDown();
            } else {
                $('#featureCode').html('<option value="">Select a class first</option>').parent().parent().slideUp();
            }
        });

        $('#searchTab').click(function() {
            if (!$(this).hasClass('active')) {
                map.addControl(drawControl);
                editableLayers.clearLayers();
                markers.clearLayers();
                $('#results-table').html('');
                $("#processed").hide();
            }
        });

        $('#extractTab').click(function() {
            if (!$(this).hasClass('active')) {
                map.removeControl(drawControl);
                editableLayers.clearLayers();
                markers.clearLayers();
                window.geo = null;
                $('#results-table').html('');
                $("#extracted").show();
            }
        });

        $(document).bind('keypress', function(e) {
            if (e.keyCode == 13) {
                if ($('#submitButton').is(":visible")) {
                    $('#submitButton').click();
                } else if ($('#extractButton').is(":visible")) {
                    $('#extractButton').click();
                }
            }
        });

        //our submit button observer for clicks
        $('#submitButton').click(function() {
            $(this).prop("disabled", true);
            submitData();
        });
        $('#extractButton').click(function() {
            $(this).prop("disabled", true);
            submitExtractData();
            $("#extracted").slideUp();
            $("#processed").slideDown();

        });
        $('#processedButton').click(function() {
            $("#processed").slideUp();
            $("#extracted").slideDown();
        });
    });
    </script>
</body>

</html>
